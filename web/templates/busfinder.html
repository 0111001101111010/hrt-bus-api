<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
	<script type="text/javascript" src="/static/bus.js"></script>
    <script type="text/javascript">

		Date.prototype.addHours = function(h){
		    this.setHours(this.getHours()+h);
		    return this;
		}
	
        var map;
        var userPosition;
		var stopPosition;
        var busesOnMap = [];
		var stopsOnMap = [];
        var visibleBus;
        
        function createMap(position) {
            map = new google.maps.Map($('#mapcanvas')[0], {
                zoom: 11,
                mapTypeControl: false,
                navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
			setMapSize();
			
			if(position) {
				userPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				new google.maps.Marker({
	                position: userPosition,
	                map: map,
	                title: "I am here!"
	            });
			} else {
				userPosition = new google.maps.LatLng(36.863794,-76.285608);
			}
			map.setCenter(userPosition);
        }

		function setMapSize() {
			$('#mapcanvas').height($(window).height() - $('#header').outerHeight() - $('#content').outerHeight())
		}

        function showBuses() {
            clearBusesOnMap();
            $('#msg').val('');
            
            $.getJSON("/api/buses/on_route/" + $("#routeNumber").val())
                .done(function (buses) {
                    $('#msg').text(buses.length + ' buses found');

		            var bounds = new google.maps.LatLngBounds();
		            bounds.extend(userPosition);
		            $.each(buses, function () {
		                var bus = new Bus(this);
		                bus.addToMap();
		                bounds.extend(bus.position);
		                busesOnMap.push(bus);
		            });
		            map.fitBounds(bounds);
                });
        }

		function clearBusesOnMap() {
            $.each(busesOnMap, function() { this.destroy(); });
            busesOnMap.length = 0;
        }
		
		function showContent(contentId) {
			$('.option').hide();
			$('#' + contentId).show();
		}
		
		function locationSearchOnPosition() {
			$.getJSON('/api/stops/near/' + userPosition.lat() + '/' + userPosition.lng() + '/')
			 .done(showLocationSearchResults);
		}
		
		function locationSearchOnIntersection() {
			$.getJSON('/api/stops/near/intersection/' + $('#city').val() + '/' + $('#intersection').val() + '/')
			 .done(showLocationSearchResults);
		}
		
		function showLocationSearchResults(results) {
			clearStopSearchResults();
				
			var bounds = new google.maps.LatLngBounds();
			$.each(results, function() {
				var position = new google.maps.LatLng(this.location[1], this.location[0]);
				bounds.extend(position);
				
                var marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title: this.stopName
                });
				stopsOnMap.push(marker);
				
				infoWindowContent = this.stopName;
				infoWindowContent += '<br>Stop ID: ' + this.stopId;
				infoWindowContent += '<br>Inbound Routes: ' + (this.inboundRoutes.length ? this.inboundRoutes.join() : 'None');
				infoWindowContent += '<br>Outbound Routes: ' + (this.outboundRoutes.length ? this.outboundRoutes.join() : 'None');
				infoWindowContent += '<br><button id="chooseStop_'+ this.stopId +'" style="width:100%; font-size:18px;">Choose Stop</button>';
				infoWindow = new google.maps.InfoWindow({
                    content: infoWindowContent
                });

				var context = this;
                google.maps.event.addListener(marker, 'click', function () {
					infoWindow.open(map, marker);
				});	
				google.maps.event.addListener(infoWindow, 'domready', function () {
					$('#chooseStop_' + context.stopId).click(function(){setStop(context);})
				});
				
			});
			map.fitBounds(bounds);
		}
		
		function clearStopSearchResults() {
			while(stopsOnMap.length)
				stopsOnMap.pop().setMap(null);
		}
		
		function setStop(stop) {
			alert(stop.stopId);
			stopPosition = new google.maps.LatLng(stop.location[1], stop.location[0]);
			var marker = new google.maps.Marker({
                position: stopPosition,
                map: map,
                title: stop.stopName
            });
			//map.setCenter(stopPosition);
			
			clearStopSearchResults();
			showRouteSelect();
		}
		
		function geoError() {
			var errMsg = typeof msg == 'string' ? msg : "Geolocation failed";
            $('#msg').html(errMsg);
			createMap();
		}

        $(document).ready(function () {
			$(window).resize(setMapSize);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(createMap, geoError);
            } else {
                createMap();
            }

            $.getJSON("/api/routes/active/")
                .done(function (result) {
                    var options = $("#routeNumber");
                    $.each(result, function() {
                        options.append($("<option />").val(this.route_id).text(this.route_short_name + " - " + this.route_long_name));
                    });
                    options.append($("<option />").val(0).text("No Route"));
                });
        });
    </script>
</head>
<body>
    <div id="header" data-role="header">
        <h3>HRT Buses</h3>
    </div>
    <div id="content" data-role="content">
		<div id="useStopOption" class="option">
			<button onclick="showContent('stopSearchOption')">Find My Stop</button>
			<button onclick="showContent('routeSelect')">Skip To Routes</button>
		</div>
		
		<div id="stopSearchOption"  class="option" style="display:none;">
			<button onclick="locationSearchOnPosition()">Use Current Location</button>
			<button onclick="showContent('stopSearch')">Use Intersection</button>
		</div>
		
		<div id="stopSearch" class="option" style="display:none;">
			Intersection:<input id="intersection" type="text" placeholder="High and Court"/>
			City: <input id="city" type="text" placeholder="Portsmouth"/>
			<button onclick="locationSearchOnIntersection()">Search</button>
		</div>
		
		<div id="routeSelect" class="option" style="display:none;">
			<select id="routeNumber" onchange="showBuses()">
				<option selected="selected" value="">Select Route</option>
			</select>
		</div>
		
		<div id="msg"></div>
    </div>
    
    <div id="mapcanvas" style="height: 400px; width: 100%;"></div>
</body>
</html>
